<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#6c4df5" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>📦 Estoque de Materiais Headset</title>

  <link rel="manifest" href="manifest.json">

  <style>
    :root{
      --ink:#0f1431; --muted:#7077a3; --violet:#6c4df5; --line:#ecebff;
      --shadow: 0 32px 60px rgba(108,77,245,.18), 0 12px 28px rgba(17,24,39,.10), 0 2px 6px rgba(17,24,39,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#fff;color:var(--ink);font:600 16px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
    .wrap{max-width:1035px;margin:0 auto;padding:max(14px,env(safe-area-inset-top)) max(14px,env(safe-area-inset-right)) max(26px,env(safe-area-inset-bottom)) max(14px,env(safe-area-inset-left))}
    header{display:flex;flex-direction:column;align-items:center;gap:16px;padding:12px 0 8px}
    .logo{width:108px;height:auto;filter:drop-shadow(0 14px 24px rgba(108,77,245,.26))}
    h1{margin:0;font-size:clamp(1.8rem,2.6rem,6vw);text-align:center;color:#2a38d9;text-shadow:0 14px 26px rgba(108,77,245,.28);letter-spacing:.2px}
    .section{background:#fff;border:1px solid var(--line);border-radius:22px;padding:18px;margin:16px 0;box-shadow:var(--shadow)}
    .title{margin:2px 0 14px;text-align:center;font-weight:900;font-size:1.6rem;color:#5b47ee;letter-spacing:.3px}
    .card{background:#fff;border:1px solid var(--line);border-radius:18px;padding:14px;margin:12px 0;box-shadow:var(--shadow)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .name{font-size:1.35rem}
    .code{color:var(--muted)}
    select,input{font:600 15px/1.2 inherit}
    .tipo,.qty,.obs{background:#fff;border:1px solid #dcdafc;border-radius:12px;box-shadow:0 10px 18px rgba(108,77,245,.10);padding:.6rem .75rem}
    .qty{min-width:74px}
    .obs{min-width:16rem;flex:1}
    .btn{appearance:none;border:0;border-radius:12px;padding:.65rem .95rem;color:#fff;cursor:pointer;font-weight:800;letter-spacing:.2px;transition:transform .06s ease}
    .btn:active{transform:scale(.985)}
    .ok{background:linear-gradient(135deg,#7e8dff,#5765ff)}
    .in{background:linear-gradient(135deg,#15d6be,#12b39a)}
    .out{background:linear-gradient(135deg,#ff669d,#ff2d62)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    .badge{border-radius:999px;padding:.55rem .9rem;font-weight:900;border:2px solid var(--line);background:#fafaff}
    .b-ok{border-color:#20b27a}.b-warn{border-color:#f2b148}.b-danger{border-color:#ff2d62}
    footer{text-align:center;margin:22px 0 6px;color:#7b80aa;font-weight:700}
    footer b{color:#0f1431}
    /* Esconde banners azuis do Docs/iOS se aparecerem */
    body>div[style*="#e8f0fe"], body>div[style*="rgb(232, 240, 254)"]{display:none!important;height:0!important;overflow:hidden!important;visibility:hidden!important}
    /* Mini toast p/ erros */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;padding:.8rem 1rem;border-radius:12px;font-weight:700;box-shadow:0 10px 26px rgba(0,0,0,.25);display:none;z-index:9999}

    /* ===== Overlay + Spinner (progresso) ===== */
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:saturate(120%) blur(2px);z-index:9998}
    .spinner{width:86px;height:86px;border-radius:999px;border:8px solid #eee;border-top-color:var(--violet);animation:spin 1s linear infinite;background:#fff;box-shadow:0 20px 46px rgba(0,0,0,.25), 0 6px 16px rgba(0,0,0,.18)}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img class="logo" src="logo.png" alt="Headset Brasil">
      <h1>Estoque de Materiais Headset</h1>
    </header>

    <section class="section">
      <div class="title">Produtos</div>
      <div id="produtos">—</div>
    </section>

    <section class="section">
      <div class="title">Estoque Atual</div>
      <div id="estoque">—</div>
    </section>

    <footer>Desenvolvido por <b>Alexandre Cavalcante — HD TECH —</b></footer>
  </div>

  <!-- Overlay de progresso -->
  <div class="overlay" id="overlay"><div class="spinner" aria-label="Carregando"></div></div>
  <div class="toast" id="toast">Falha</div>

  <script>
    /* =========================
       ALTERE no GitHub (se publicar novo GAS):
       Deixe o seu endpoint /exec aqui.
       ========================= */
    const API_EXEC = "https://script.google.com/macros/s/AKfycbxA2iQBbqP3HBtIA0IoNKuhPogdmjoHQoJvG-VGL6lSy5HlsyJNIpcBF5o38ARTpleMow/exec";

    /* ===== helpers UI ===== */
    const $ = s => document.querySelector(s);
    const elProdutos = $('#produtos');
    const elEstoque  = $('#estoque');
    const toast = $('#toast');
    const overlay = $('#overlay');

    function showToast(msg){ toast.textContent = msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1600); }
    function showOverlay(v){ overlay.style.display = v ? 'flex' : 'none'; }

    function classByLevel(estoque, minimo){
      estoque=Number(estoque||0); minimo=Number(minimo||0);
      if(minimo>0){
        if(estoque <= 0.25*minimo) return 'b-danger';
        if(estoque <  minimo)      return 'b-warn';
      }
      return 'b-ok';
    }

    function productCard(it){
      const qtdOpts = Array.from({length:50}, (_,i)=>`<option value="${i+1}">${i+1}</option>`).join('');
      return `
        <div class="card" id="c-${it.codigo}">
          <div class="row" style="width:100%">
            <div>
              <div class="name">${it.nome}</div>
              <div class="code">Cód: ${it.codigo} • Estoque: <b id="left-${it.codigo}">${it.estoque ?? 0}</b></div>
            </div>
            <div class="row" style="flex:1; min-width:260px">
              <select class="tipo" id="tipo-${it.codigo}">
                <option value="Unidade">Unidade</option>
                <option value="CX">CX</option>
                <option value="Litro">Litro</option>
              </select>
              <select class="qty" id="qty-${it.codigo}">${qtdOpts}</select>
              <input class="obs" id="obs-${it.codigo}" placeholder="Obs/Justificativa" maxlength="180" />
              <button class="btn ok"  onclick="clickObs('${it.codigo}')">OK</button>
              <button class="btn in"  onclick="clickMov('ENTRADA','${it.codigo}')">Entrada</button>
              <button class="btn out" onclick="clickMov('SAÍDA','${it.codigo}')">Saída</button>
            </div>
          </div>
        </div>`;
    }

    function stockCard(it){
      return `
        <div class="card">
          <div class="row" style="width:100%">
            <div>
              <div class="name">${it.nome}</div>
              <div class="code">Cód: ${it.codigo}</div>
            </div>
            <div class="badge ${classByLevel(it.estoque, it.minimo)}" id="b-${it.codigo}">
              Estoque: <span id="est-${it.codigo}">${it.estoque ?? 0}</span>
            </div>
          </div>
        </div>`;
    }

    function render(items){
      elProdutos.innerHTML = items.map(productCard).join('');
      elEstoque.innerHTML  = items.map(stockCard).join('');
    }

    /* ===== chamadas ===== */
    async function callAPI(params){
      const qp = new URLSearchParams(params);
      const url = API_EXEC + '?' + qp.toString() + '&ts=' + Date.now();
      const r = await fetch(url, { method:'GET', mode:'cors', cache:'no-store', redirect:'follow', credentials:'omit' });
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }
    function apiList(){ return callAPI({act:'list'}); }
    function apiMov({tipo,codigo,qtd,unid,obs}){
      return callAPI({act:'mov', tipo, codigo, qtd, unid, obs});
    }
    function apiObs({codigo,obs}){
      return callAPI({act:'obs', codigo, obs});
    }

    /* ===== util ===== */
    function findItem(cod){ return (window._items||[]).find(x=>x.codigo===cod); }
    function setButtonsDisabled(codigo, disabled){
      const ids = [`obs-${codigo}`];
      const btns = Array.from(document.querySelectorAll(`#c-${codigo} .btn`));
      btns.forEach(b=>b.disabled = disabled);
      const sel = document.querySelectorAll(`#c-${codigo} select, #c-${codigo} input`);
      sel.forEach(el=>el.disabled = disabled);
    }

    /* ===== Actions ===== */
    async function clickMov(tipo, codigo){
      try{
        setButtonsDisabled(codigo, true);
        showOverlay(true);
        const qtd  = Number(document.getElementById('qty-'+codigo)?.value || 1);
        const unid = String(document.getElementById('tipo-'+codigo)?.value || 'Unidade');
        const obs  = String(document.getElementById('obs-'+codigo)?.value || '');
        const res  = await apiMov({ tipo, codigo, qtd, unid, obs });
        if(res && res.ok){
          const it = findItem(codigo); if(it) it.estoque = res.estoque;
          const l = document.getElementById('left-'+codigo);
          const e = document.getElementById('est-'+codigo);
          const b = document.getElementById('b-'+codigo);
          if(l) l.textContent = res.estoque;
          if(e) e.textContent = res.estoque;
          if(b && it) b.className = 'badge ' + classByLevel(res.estoque, it.minimo||0);
        }else{
          showToast('Falha ao movimentar.');
        }
      }catch(err){
        console.error(err);
        showToast('Erro ao movimentar: ' + (err?.message||err));
      }finally{
        showOverlay(false);
        setButtonsDisabled(codigo, false);
      }
    }

    async function clickObs(codigo){
      try{
        const obs = String(document.getElementById('obs-'+codigo)?.value || '').trim();
        if(!obs){ showToast('Escreva a observação.'); return; }
        setButtonsDisabled(codigo, true);
        showOverlay(true);
        const res = await apiObs({ codigo, obs });
        if(res && res.ok){
          document.getElementById('obs-'+codigo).value = '';
          showToast('Observação salva');
        }else{
          showToast('Falha ao salvar observação.');
        }
      }catch(err){
        console.error(err);
        showToast('Erro ao salvar: ' + (err?.message||err));
      }finally{
        showOverlay(false);
        setButtonsDisabled(codigo, false);
      }
    }

    /* ===== Boot ===== */
    (async function init(){
      try{
        showOverlay(true);
        const data = await apiList();
        if(!data || !data.ok) throw new Error('Resposta inválida');
        window._items = (data.items||[]).map(x=>Object.assign({},x));
        render(window._items);
      }catch(e){
        console.error(e);
        elProdutos.textContent = 'Erro ao carregar.';
        elEstoque.textContent  = '—';
        showToast('Falha ao carregar lista');
      }finally{
        showOverlay(false);
      }
    })();
  </script>
</body>
</html>
