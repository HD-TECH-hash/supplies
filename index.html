<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RIC AI — CRION</title>
<style>
  :root{
    --brand:#2882bb; --brand2:#2a8fcf;
    --bg:#f7f8fc; --ink:#0f172a; --muted:#667085; --line:#E7EAF3;
    --lime:#22c55e; --lime2:#a3e635; --danger:#ef4444;
    --tag:#F2E7FF; --tag-ink:#6D28D9;
    --card-shadow:0 18px 36px rgba(99,102,241,.12), 0 8px 24px rgba(40,130,187,.10);
  }
  *{box-sizing:border-box}
  body{margin:0;font:14px/1.55 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--ink);
       background:radial-gradient(1200px 520px at -10% -10%, #eaf4ff 0, #ffffff 60%, #f7faff 100%)}
  .wrap{max-width:1060px;margin:0 auto;padding:18px}

  .hero{position:relative;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;
        border-radius:18px;padding:12px 16px;display:flex;align-items:center;justify-content:center;
        box-shadow:0 24px 56px rgba(40,130,187,.22)}
  .hero .center-logo{height:44px;object-fit:contain;filter:drop-shadow(0 2px 6px #0002)}
  .hero .logo{width:120px;height:auto;object-fit:contain;filter:drop-shadow(0 2px 6px #0002)}
  .left{position:absolute;left:14px;top:50%;transform:translateY(-50%)}
  .right-img{position:absolute;right:14px;top:50%;transform:translateY(-50%)}
  .tools{position:absolute;right:150px;top:50%;transform:translateY(-50%);display:flex;gap:10px}
  .iconbtn{width:36px;height:36px;border-radius:10px;border:1px solid #ffffff40;background:#ffffff1a;
           display:grid;place-items:center;cursor:pointer;backdrop-filter:blur(4px);transition:.15s}
  .iconbtn:hover{transform:translateY(-1px);background:#ffffff22}

  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} .right-img{display:none} }

  .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:var(--card-shadow)}
  .tag{display:inline-flex;align-items:center;gap:8px;background:var(--tag);color:var(--tag-ink);
       border:1px solid #eadbff;border-radius:999px;padding:6px 12px;font-weight:800;font-size:12px}
  h2{margin:8px 0 10px;font-size:18px}
  .row{display:flex;gap:10px;align-items:center}
  .input{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fbfcff}
  .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
  .btn-search{color:#053; background:linear-gradient(135deg,var(--lime),var(--lime2)); box-shadow:0 10px 22px rgba(34,197,94,.28)}
  .btn-plain{background:#f7f7fb;color:#111;border:1px solid var(--line)}
  .btn-danger{background:var(--danger);color:#fff;box-shadow:0 10px 22px rgba(239,68,68,.24)}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  .out{white-space:pre-wrap;min-height:120px;border:1px dashed var(--line);border-radius:10px;padding:10px;margin-top:10px;background:#fbfbff}

  .widget{position:fixed;right:18px;top:82px;z-index:50;display:none}
  .note{width:220px;background:#fff3b0;border:1px solid #f5d565;border-radius:12px;box-shadow:0 14px 30px #0001;padding:10px}
  .note textarea{width:100%;height:120px;border:0;background:transparent;outline:none;font:14px/1.45 ui-sans-serif}
  .calc{width:260px;background:#fff;border:1px solid #dbe0ea;border-radius:12px;box-shadow:0 14px 30px #0001;padding:12px}
  .calc .screen{border:1px solid var(--line);border-radius:10px;padding:10px;font-weight:700;margin-bottom:10px;background:#f9fbff}
  .keys{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .key{padding:10px;border-radius:10px;border:1px solid #e6e9f2;background:#f7f8fd;cursor:pointer;text-align:center;font-weight:800}
  .key.op{background:#eef6ff;border-color:#cfe7ff}
  .key.eq{background:linear-gradient(135deg,var(--lime),var(--lime2));color:#053}

  footer{margin:18px 0 8px;text-align:center}
  .footnote{font-size:12px;color:#94a3b8}
</style>
</head>
<body>
  <div class="wrap">
    <!-- TOPO -->
    <div class="hero">
      <img class="logo left" src="icon.png" alt="Logo esquerdo">
      <img class="center-logo" src="RICai.png" alt="RIC AI CRION">
      <div class="tools">
        <button id="toggleNote" class="iconbtn" title="Post-it">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M8 3h8a3 3 0 0 1 3 3v7l-7 7H8a3 3 0 0 1-3-3V6a3 3 0 0 1 3-3Z" stroke="#FFD54F" stroke-width="2"/>
            <path d="M19 13h-4a3 3 0 0 0-3 3v4" stroke="#FFD54F" stroke-width="2"/>
          </svg>
        </button>
        <button id="toggleCalc" class="iconbtn" title="Calculadora">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <rect x="4" y="3" width="16" height="18" rx="2" stroke="#22C55E" stroke-width="2"/>
            <rect x="7" y="6" width="10" height="3" rx="1" fill="#22C55E"/>
            <path d="M8 12h2M8 16h2M12 12h2M12 16h2M16 12h2M16 16h2" stroke="#22C55E" stroke-width="2"/>
          </svg>
        </button>
      </div>
      <img class="logo right-img" src="icon2.png" alt="Logo direito">
    </div>

    <!-- WIDGETS -->
    <div id="noteWrap" class="widget note">
      <div class="row" style="justify-content:space-between;margin-bottom:6px">
        <b>Post-it</b>
        <button id="clearNote" class="btn btn-plain" style="padding:4px 8px">Limpar</button>
      </div>
      <textarea id="noteArea" placeholder="Anote algo..."></textarea>
    </div>

    <div id="calcWrap" class="widget calc">
      <div class="row" style="justify-content:space-between;margin-bottom:6px">
        <b>Calculadora</b>
        <button id="closeCalc" class="btn btn-plain" style="padding:4px 8px">Fechar</button>
      </div>
      <div class="screen" id="scr">0</div>
      <div class="keys" id="keys">
        <div class="key op" data-k="C">C</div>
        <div class="key op" data-k="±">±</div>
        <div class="key op" data-k="%">%</div>
        <div class="key op" data-k="/">÷</div>
        <div class="key" data-k="7">7</div><div class="key" data-k="8">8</div><div class="key" data-k="9">9</div><div class="key op" data-k="*">×</div>
        <div class="key" data-k="4">4</div><div class="key" data-k="5">5</div><div class="key" data-k="6">6</div><div class="key op" data-k="-">−</div>
        <div class="key" data-k="1">1</div><div class="key" data-k="2">2</div><div class="key" data-k="3">3</div><div class="key op" data-k="+">+</div>
        <div class="key" data-k="0">0</div><div class="key" data-k="00">00</div><div class="key" data-k=".">.</div><div class="key eq" data-k="=">=</div>
      </div>
    </div>

    <!-- CARDS -->
    <div class="grid">
      <section class="card">
        <div class="tag">ALERTA</div>
        <h2>Controle de alerta</h2>
        <div class="row">
          <button id="btnAlert" class="btn btn-search">Pesquisar</button>
          <button id="btnAdjust" class="btn btn-plain">Ajustar</button>
        </div>
        <div class="hint" id="alertBusy" style="display:none">
          <div class="busy"><div class="spinner"></div><div>Pesquisando alerta...</div></div>
          <div class="bar" style="margin-top:6px"></div>
        </div>
        <div id="alertMsg"  style="display:none;font-size:22px;font-weight:900;color:#b91c1c;text-align:center;margin-top:8px">—</div>
        <div id="alertResp" style="display:none;font-size:13px;font-weight:600;color:#334155;text-align:center;margin-top:4px;text-transform:lowercase">—</div>
      </section>

      <section class="card">
        <div class="tag">SITES OFICIAIS</div>
        <h2>CRION COMERCIAL (AFFIX, ALTER e CONECTA PLAN)</h2>
        <div class="row" style="margin-top:6px">
          <input id="qSites" class="input" placeholder="Digite sua pergunta .....">
          <button id="btnSites" class="btn btn-search">Pesquisar</button>
        </div>
        <div class="hint" id="sitesBusy" style="display:none">
          <div class="busy"><div class="spinner"></div><div>Pesquisando...</div></div>
          <div class="bar" style="margin-top:6px"></div>
        </div>
        <div id="outSites" class="out">—</div>
      </section>

      <section class="card">
        <div class="tag">PDFs</div>
        <h2>Manuais do Corretor (Sharepoint)</h2>
        <p class="hint">Busca rápida no texto extraído dos PDFs (indexados).</p>
        <div class="row">
          <input id="qPDF" class="input" placeholder="Ex.: Affix, Coparticipação, Carência 30 dias">
          <button id="btnPDF" class="btn btn-search" style="min-width:112px">Pesquisar</button>
        </div>
        <div class="hint" id="pdfBusy" style="display:none">
          <div class="busy"><div class="spinner"></div><div>Listando arquivos...</div></div>
          <div class="bar" style="margin-top:6px"></div>
        </div>
        <div id="pdfStatus" class="hint" style="margin-top:6px">—</div>
        <ul id="pdfList" style="margin:8px 0 0;padding:0;list-style:none"></ul>
      </section>

      <section class="card">
        <div class="tag">PROCEDIMENTOS CRION</div>
        <h2>Procedimentos</h2>
        <p class="hint">Material de Treinamento, Quiz, Alertas &gt; 30 dias e demais informações.</p>
        <div class="row">
          <input id="qCRION" class="input" placeholder="Ex.: Onboarding, Retenção, URA, Script de Cobrança, Affix">
          <button id="btnCRION" class="btn btn-search" style="min-width:112px">Pesquisar</button>
          <button id="btnReIdxCRION" class="btn btn-danger" style="min-width:112px">Reindexar</button>
        </div>
        <div class="hint" id="crionBusy" style="display:none">
          <div class="busy"><div class="spinner"></div><div>Listando procedimentos...</div></div>
          <div class="bar" style="margin-top:6px"></div>
        </div>
        <div id="crionStatus" class="hint" style="margin-top:6px">—</div>
        <ul id="crionList" style="margin:8px 0 0;padding:0;list-style:none"></ul>
      </section>
    </div>

    <footer><span class="footnote">Desenvolvido por Alexandre Cavalcante V3.0</span></footer>
  </div>

<script>
/*** CONFIG — seu WebApp público (sem login) ***/
const APP_URL = 'https://script.google.com/macros/s/AKfycbw6uzRI4069YZmoizZFB0p8XmPqw1dw_IfxFaKGd33_3HQDF5RbBc-4_dHLj1YmCNGDgQ/exec';

/*** HELPERS ***/
const $ = s => document.querySelector(s);
const show = (el, on=true)=>{ if(!el) return; el.style.display = on? '' : 'none'; };
function esc(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function cleanName(n){ return String(n||'').replace(/^(OCR_TMP_|TMP_SLIDES_)+/ig,''); }
function link(url, txt){ return `<a href="${url}" target="_blank" rel="noopener">${esc(txt||url)}</a>`; }
function humanSize(b){ if(!b||b<=0) return "—"; const u=["B","KB","MB","GB"]; let i=0; while(b>=1024&&i<u.length-1){ b/=1024; i++; } return b.toFixed(1)+" "+u[i]; }

/*** Dispatcher GitHub: sempre via fetch ***/
function call(endpoint, payload){
  const url = APP_URL + "?fn=" + encodeURIComponent(endpoint);
  return fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload||{}) })
    .then(r=>{ if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); });
}

/*** ALERTA ***/
function openM(){/* no GH não usamos modais de ajuste para simplificar */}

/* Botões */
document.addEventListener('DOMContentLoaded', ()=>{
  /* Alertas */
  const msg=$('#alertMsg'), resp=$('#alertResp');
  $('#btnAlert').addEventListener('click', async ()=>{
    show(msg,false); show(resp,false); show($('#alertBusy'),true);
    try{
      const r = await call('getalert',{});
      if(!r || r.ok===false){ msg.textContent="Falha ao consultar."; show(msg,true); return; }
      if(!r.found){ msg.textContent="Sem recado no momento."; show(msg,true); return; }
      msg.textContent = "🚨 " + String(r.mensagem||"—").toUpperCase(); show(msg,true);
      if(r.responsavel){ resp.textContent = String(r.responsavel||"").toLowerCase(); show(resp,true); }
    }catch(e){ msg.textContent='Erro: '+e.message; show(msg,true);
    }finally{ show($('#alertBusy'),false); }
  });

  /* Chat / Sites */
  $('#btnSites').addEventListener('click', async ()=>{
    const q=($('#qSites').value||'').trim();
    if(!q){ $('#outSites').textContent='Digite a pergunta.'; return; }
    show($('#sitesBusy'),true); $('#outSites').textContent='—';
    try{
      const r = await call('chat',{ q: q + " — responda em português e liste as URLs oficiais no final." });
      const txt = (r && r.text) ? r.text : '—';
      const html = String(txt).replace(/(https?:\/\/[^\s]+)/g, m=>`<a href="${m}" target="_blank" rel="noopener">${m}</a>`);
      $('#outSites').innerHTML = html;
    }catch(e){ $('#outSites').textContent='Erro: '+e.message;
    }finally{ show($('#sitesBusy'),false); }
  });

  /* PDFs */
  $('#btnPDF').addEventListener('click', doPDF);
  $('#qPDF').addEventListener('keydown', e=>{ if(e.key==='Enter') doPDF(); });
  async function doPDF(){
    const q=($('#qPDF').value||'').trim();
    if(!q){ $('#pdfStatus').textContent='Digite um termo.'; return; }
    show($('#pdfBusy'),true); $('#pdfStatus').textContent='Listando arquivos...'; $('#pdfList').innerHTML="";
    try{
      const res = await call('searchindexed',{q});
      if(!res || res.ok===false){ $('#pdfStatus').textContent='Erro ao buscar: '+(res&&res.message?res.message:''); return; }
      const items=res.items||[]; $('#pdfStatus').textContent=`Resultados: ${items.length}`;
      const frag=document.createDocumentFragment();
      items.forEach((it,idx)=>{
        const li=document.createElement('li'); li.style.padding="10px 0"; li.style.borderTop="1px solid var(--line)"; li.id='pdf_'+idx;
        const meta = `<div class="hint">Tamanho: ${humanSize(it.size||0)} • Atualizado: ${it.updated? new Date(it.updated).toLocaleString(): "—"}</div>`;
        li.innerHTML=`<div><b>${esc(cleanName(it.name))}</b> • ${link(it.url,'Abrir')}</div>${meta}`;
        frag.appendChild(li);
      });
      $('#pdfList').appendChild(frag);
    }catch(e){ $('#pdfStatus').textContent='Erro: '+e.message;
    }finally{ show($('#pdfBusy'),false); }
  }

  /* CRION */
  $('#btnCRION').addEventListener('click', doCRION);
  $('#btnReIdxCRION').addEventListener('click', async ()=>{
    $('#crionStatus').textContent='Reindexando CRION…'; show($('#crionBusy'),true);
    try{ const r=await call('reindexcrion',{}); $('#crionStatus').textContent="Index CRION: "+(r && r.ok ? "OK" : "Falhou"); }
    catch(e){ $('#crionStatus').textContent='Erro: '+e.message; }
    finally{ show($('#crionBusy'),false); }
  });
  async function doCRION(){
    const q=($('#qCRION').value||'').trim();
    if(!q){ $('#crionStatus').textContent='Digite um termo.'; return; }
    show($('#crionBusy'),true); $('#crionStatus').textContent='Listando arquivos…'; $('#crionList').innerHTML="";
    try{
      const res = await call('searchcrion',{q});
      if(!res || res.ok===false){ $('#crionStatus').textContent='Erro ao buscar: '+(res&&res.message?res.message:''); return; }
      const items=res.items||[]; $('#crionStatus').textContent=`Resultados: ${items.length}`;
      const frag=document.createDocumentFragment();
      items.forEach((it,idx)=>{
        const li=document.createElement('li'); li.style.padding="10px 0"; li.style.borderTop="1px solid var(--line)"; li.id='crion_'+idx;
        const meta  = `<div class="hint">Tamanho: ${humanSize(it.size||0)} • Atualizado: ${it.updated? new Date(it.updated).toLocaleString(): "—"}</div>`;
        li.innerHTML=`<div><b>${esc(cleanName(it.name))}</b> • ${link(it.url,'Abrir')}</div>${meta}`;
        frag.appendChild(li);
      });
      $('#crionList').appendChild(frag);
    }catch(e){ $('#crionStatus').textContent='Erro: '+e.message;
    }finally{ show($('#crionBusy'),false); }
  }
});

/*** Widgets (nota e calc) ***/
const noteWrap = $('#noteWrap'), noteArea = $('#noteArea');
$('#toggleNote').onclick = ()=>{ noteWrap.style.display = noteWrap.style.display ? "" : "block"; if(noteWrap.style.display) noteArea.focus(); };
$('#clearNote').onclick = ()=>{ noteArea.value=""; localStorage.removeItem('ric_note'); };
noteArea.value = localStorage.getItem('ric_note') || "";
noteArea.addEventListener('input', ()=> localStorage.setItem('ric_note', noteArea.value));

const calc = { scr: null, buf:"0", op:null, mem:0, fresh:true };
window.addEventListener('DOMContentLoaded', ()=>{ calc.scr = document.getElementById('scr'); });
function refresh(){ calc.scr.textContent = calc.buf; }
function press(k){
  if(/\d/.test(k)){ calc.buf = (calc.fresh||calc.buf==="0")? k : calc.buf+k; calc.fresh=false; refresh(); return; }
  if(k==="00"){ press("0"); press("0"); return; }
  if(k==="."){ if(!calc.buf.includes(".")) calc.buf += "."; calc.fresh=false; refresh(); return; }
  if(k==="C"){ calc.buf="0"; calc.op=null; calc.fresh=true; refresh(); return; }
  if(k==="±"){ if(calc.buf!=="0") calc.buf = calc.buf.startsWith("-")? calc.buf.slice(1):"-"+calc.buf; refresh(); return; }
  if(k==="%"){ calc.buf = String(parseFloat(calc.buf)/100); refresh(); return; }
  if("+-*/".includes(k)){ calc.mem=parseFloat(calc.buf); calc.op=k; calc.fresh=true; return; }
  if(k==="=" && calc.op){ const a=calc.mem, b=parseFloat(calc.buf);
    let v = 0; switch(calc.op){case "+":v=a+b;break;case "-":v=a-b;break;case "*":v=a*b;break;case "/":v=b===0? "Erro" : a/b;break;}
    calc.buf = String(v); calc.op=null; calc.fresh=true; refresh();
  }
}
document.addEventListener('click', e=>{ const k=e.target.dataset && e.target.dataset.k; if(k) press(k); });
$('#toggleCalc').onclick = ()=>{ $('#calcWrap').style.display = $('#calcWrap').style.display? "" : "block"; };
$('#closeCalc').onclick = ()=>{ $('#calcWrap').style.display="none"; };
</script>
</body>
</html>
