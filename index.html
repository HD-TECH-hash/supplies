<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#6c4df5" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>📦 Estoque de Materiais Headset</title>
  <link rel="manifest" href="manifest.json">
  <style>
    :root{
      --ink:#0f1431; --muted:#7077a3; --violet:#6c4df5; --line:#ecebff;
      --shadow: 0 32px 60px rgba(108,77,245,.18), 0 12px 28px rgba(17,24,39,.10), 0 2px 6px rgba(17,24,39,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#fff;color:var(--ink);font:600 16px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:max(14px,env(safe-area-inset-top)) max(14px,env(safe-area-inset-right)) max(26px,env(safe-area-inset-bottom)) max(14px,env(safe-area-inset-left))}
    header{display:flex;flex-direction:column;align-items:center;gap:16px;padding:12px 0 8px}
    .logo{width:108px;height:auto;filter:drop-shadow(0 14px 24px rgba(108,77,245,.26))}
    h1{margin:0;font-size:clamp(1.8rem,2.6rem,6vw);text-align:center;color:#2a38d9;text-shadow:0 14px 26px rgba(108,77,245,.28);letter-spacing:.2px}
    .section{background:#fff;border:1px solid var(--line);border-radius:22px;padding:18px;margin:16px 0;box-shadow:var(--shadow)}
    .title{margin:2px 0 14px;text-align:center;font-weight:900;font-size:1.6rem;color:#5b47ee;letter-spacing:.3px}
    .card{background:#fff;border:1px solid var(--line);border-radius:18px;padding:14px;margin:12px 0;box-shadow:var(--shadow)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .name{font-size:1.35rem}
    .code{color:var(--muted)}
    select,input{font:600 15px/1.2 inherit}
    .tipo,.qty,.obs{background:#fff;border:1px solid #dcdafc;border-radius:12px;box-shadow:0 10px 18px rgba(108,77,245,.10);padding:.6rem .75rem}
    .qty{min-width:74px}
    .obs{min-width:16rem;flex:1}
    .btn{appearance:none;border:0;border-radius:12px;padding:.65rem .95rem;color:#fff;cursor:pointer;font-weight:800;letter-spacing:.2px;transition:transform .06s ease}
    .btn:active{transform:scale(.985)}
    .ok{background:linear-gradient(135deg,#7e8dff,#5765ff)}
    .in{background:linear-gradient(135deg,#15d6be,#12b39a)}
    .out{background:linear-gradient(135deg,#ff669d,#ff2d62)}
    .badge{border-radius:999px;padding:.55rem .9rem;font-weight:900;border:2px solid var(--line);background:#fafaff}
    .b-ok{border-color:#20b27a}.b-warn{border-color:#f2b148}.b-danger{border-color:#ff2d62}
    footer{text-align:center;margin:22px 0 6px;color:#7b80aa;font-weight:700}
    footer b{color:#0f1431}
    body>div[style*="#e8f0fe"], body>div[style*="rgb(232, 240, 254)"]{display:none!important;height:0!important;overflow:hidden!important;visibility:hidden!important}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;padding:.8rem 1rem;border-radius:12px;font-weight:700;box-shadow:0 10px 26px rgba(0,0,0,.25);display:none;z-index:9999}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img class="logo" src="logo.png" alt="Headset Brasil">
      <h1>Estoque de Materiais Headset</h1>
    </header>

    <section class="section">
      <div class="title">Produtos</div>
      <div id="produtos">—</div>
    </section>

    <section class="section">
      <div class="title">Estoque Atual</div>
      <div id="estoque">—</div>
    </section>

    <footer>Desenvolvido por <b>Alexandre Cavalcante — HD TECH —</b></footer>
  </div>

  <div class="toast" id="toast">Falha</div>

  <script>
    /* =========================
       🔁 ALTERE no GitHub (já deixei seu /exec aqui):
       ========================= */
    const API_BASE = "https://script.google.com/macros/s/AKfycbxA2iQBbqP3HBtIA0IoNKuhPogdmjoHQoJvG-VGL6lSy5HlsyJNIpcBF5o38ARTpleMow/exec";

    const $ = s => document.querySelector(s);
    const elProdutos = $('#produtos');
    const elEstoque  = $('#estoque');
    const toast = $('#toast');
    function showToast(msg){ toast.textContent = msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',2000); }

    function classByLevel(estoque, minimo){
      estoque=Number(estoque||0); minimo=Number(minimo||0);
      if(minimo>0){
        if(estoque <= 0.25*minimo) return 'b-danger';
        if(estoque <  minimo)      return 'b-warn';
      }
      return 'b-ok';
    }

    function productCard(it){
      const qtdOpts = Array.from({length:50}, (_,i)=>`<option value="${i+1}">${i+1}</option>`).join('');
      return `
        <div class="card" id="c-${it.codigo}">
          <div class="row" style="width:100%">
            <div>
              <div class="name">${it.nome}</div>
              <div class="code">Cód: ${it.codigo} • Estoque: <b id="left-${it.codigo}">${it.estoque ?? 0}</b></div>
            </div>
            <div class="row" style="flex:1; min-width:260px">
              <select class="tipo" id="tipo-${it.codigo}">
                <option value="Unidade">Unidade</option>
                <option value="CX">CX</option>
                <option value="Litro">Litro</option>
              </select>
              <select class="qty" id="qty-${it.codigo}">${qtdOpts}</select>
              <input class="obs" id="obs-${it.codigo}" placeholder="Obs/Justificativa" maxlength="180" />
              <button class="btn ok"  onclick="clickObs('${it.codigo}')">OK</button>
              <button class="btn in"  onclick="clickMov('ENTRADA','${it.codigo}')">Entrada</button>
              <button class="btn out" onclick="clickMov('SAÍDA','${it.codigo}')">Saída</button>
            </div>
          </div>
        </div>`;
    }

    function stockCard(it){
      return `
        <div class="card">
          <div class="row" style="width:100%">
            <div>
              <div class="name">${it.nome}</div>
              <div class="code">Cód: ${it.codigo}</div>
            </div>
            <div class="badge ${classByLevel(it.estoque, it.minimo)}" id="b-${it.codigo}">
              Estoque: <span id="est-${it.codigo}">${it.estoque ?? 0}</span>
            </div>
          </div>
        </div>`;
    }

    function render(items){
      elProdutos.innerHTML = items.map(productCard).join('');
      elEstoque.innerHTML  = items.map(stockCard).join('');
    }

    // ===== JSONP helper (evita CORS nos atalhos iOS/Android)
    function jsonp(params, timeoutMs=12000){
      return new Promise((resolve, reject)=>{
        const cb = '__cb_' + Math.random().toString(36).slice(2);
        const q  = new URLSearchParams(params);
        q.append('callback', cb);
        const url = API_BASE + (API_BASE.includes('?') ? '&' : '?') + q.toString() + '&_ts=' + Date.now();

        const s = document.createElement('script');
        let timed = false;
        const timer = setTimeout(()=>{ timed=true; cleanup(); reject(new Error('Timeout')); }, timeoutMs);

        function cleanup(){
          clearTimeout(timer);
          try{ delete window[cb]; }catch(_) { window[cb] = undefined; }
          if(s && s.parentNode) s.parentNode.removeChild(s);
        }
        window[cb] = (data)=>{
          if(timed) return;
          cleanup();
          resolve(data);
        };
        s.onerror = ()=>{ if(!timed){ cleanup(); reject(new Error('Erro de rede')); } };
        s.src = url;
        document.head.appendChild(s);
      });
    }

    // ===== API via JSONP
    function apiList(){ return jsonp({act:'list'}); }
    function apiMov({tipo,codigo,qtd,unid,obs}){
      return jsonp({
        act:'mov', tipo:String(tipo||'ENTRADA'), codigo:String(codigo||''),
        qtd:String(qtd||'0'), unid:String(unid||'Unidade'), obs:String((obs||'').slice(0,180))
      });
    }
    function apiObs({codigo,obs}){
      return jsonp({act:'obs', codigo:String(codigo||''), obs:String((obs||'').slice(0,180))});
    }

    function findItem(cod){ return (window._items||[]).find(x=>x.codigo===cod); }

    async function clickMov(tipo, codigo){
      try{
        const qtd  = Number(document.getElementById('qty-'+codigo)?.value || 1);
        const unid = String(document.getElementById('tipo-'+codigo)?.value || 'Unidade');
        const obs  = String(document.getElementById('obs-'+codigo)?.value || '');
        const res  = await apiMov({ tipo, codigo, qtd, unid, obs });
        if(res && res.ok){
          const it = findItem(codigo); if(it) it.estoque = res.estoque;
          const l = document.getElementById('left-'+codigo);
          const e = document.getElementById('est-'+codigo);
          const b = document.getElementById('b-'+codigo);
          if(l) l.textContent = res.estoque;
          if(e) e.textContent = res.estoque;
          if(b && it) b.className = 'badge ' + classByLevel(res.estoque, it.minimo||0);
        }else{
          showToast(res && res.error ? res.error : 'Falha ao movimentar.');
        }
      }catch(err){
        console.error(err);
        showToast('Erro ao movimentar: ' + (err?.message||err));
      }
    }

    async function clickObs(codigo){
      try{
        const obs = String(document.getElementById('obs-'+codigo)?.value || '').trim();
        if(!obs){ showToast('Escreva a observação.'); return; }
        const res = await apiObs({ codigo, obs });
        if(res && res.ok){
          document.getElementById('obs-'+codigo).value = '';
          showToast('Observação salva');
        }else{
          showToast(res && res.error ? res.error : 'Falha ao salvar observação.');
        }
      }catch(err){
        console.error(err);
        showToast('Erro ao salvar: ' + (err?.message||err));
      }
    }

    (async function init(){
      try{
        const data = await apiList();
        if(!data || !data.ok) throw new Error('Resposta inválida');
        window._items = (data.items||[]).map(x=>Object.assign({},x));
        render(window._items);
      }catch(e){
        console.error(e);
        elProdutos.textContent = 'Erro ao carregar.';
        elEstoque.textContent  = '—';
        showToast('Falha ao carregar lista');
      }
    })();
  </script>
</body>
</html>
